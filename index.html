<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Listado de alumnos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card-img-top { object-fit: cover; height: 200px; }
    .avatar-placeholder { display:flex; align-items:center; justify-content:center; background:#e9ecef; color:#6c757d; font-size:48px; height:200px; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center mb-4">
      <h1 class="me-auto">Alumnos</h1>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#personModal" id="btnAdd">Crear alumno</button>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <input id="search" class="form-control" placeholder="Buscar por nombre, apellido u organismo">
      </div>
    </div>

    <div id="cards" class="row g-3" aria-live="polite"></div>

    <p class="text-muted mt-3">Los datos se guardan en el <code>localStorage</code> del navegador.</p>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="personModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="personForm">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Crear alumno</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="personId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input id="firstName" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Primer apellido</label>
                <input id="lastName" class="form-control" required>
              </div>
              <div class="col-12">
                <label class="form-label">Organismo</label>
                <input id="org" class="form-control" required>
              </div>
              <div class="col-12">
                <label class="form-label">Fotografía (opcional)</label>
                <input id="photo" type="file" accept="image/*" class="form-control">
                <div class="form-text">Si no se sube fotografía se mostrará un avatar por defecto.</div>
              </div>
              <div class="col-12">
                <div id="previewWrapper" class="mt-2"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const STORAGE_KEY = 'peopleList_v1';

    // Helpers
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    function readImageAsDataUrl(file){
      return new Promise((res, rej) => {
        if (!file) return res(null);
        const reader = new FileReader();
        reader.onload = e => res(e.target.result);
        reader.onerror = () => rej(new Error('Error leyendo imagen'));
        reader.readAsDataURL(file);
      });
    }

    // CRUD en localStorage
    function loadPeople(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        console.error('Error parseando localStorage', e);
        return [];
      }
    }

    function savePeople(people){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(people));
    }

    function addPerson(person){
      const people = loadPeople();
      people.unshift(person);
      savePeople(people);
    }

    function updatePerson(updated){
      const people = loadPeople().map(p => p.id === updated.id ? updated : p);
      savePeople(people);
    }

    function deletePerson(id){
      const people = loadPeople().filter(p => p.id !== id);
      savePeople(people);
    }

    // Render
    function renderCards(filter=''){
      const container = qs('#cards');
      const people = loadPeople();
      const f = filter.trim().toLowerCase();
      const visible = people.filter(p => {
        if(!f) return true;
        return [p.firstName, p.lastName, p.org].join(' ').toLowerCase().includes(f);
      });

      if(visible.length === 0){
        container.innerHTML = '<div class="col-12"><div class="alert alert-info">No hay alumnos. Crea el primero usando "Crear alumno".</div></div>';
        return;
      }

      container.innerHTML = visible.map(p => `
        <div class="col-sm-6 col-md-4 col-lg-3">
          <div class="card h-100">
            ${p.photo ? `<img src="${p.photo}" class="card-img-top" alt="Foto de ${escapeHtml(p.firstName)} ${escapeHtml(p.lastName)}">` : `<div class="avatar-placeholder">${escapeHtml(initials(p.firstName,p.lastName))}</div>`}
            <div class="card-body d-flex flex-column">
              <h5 class="card-title mb-1">${escapeHtml(p.firstName)} ${escapeHtml(p.lastName)}</h5>
              <p class="card-text text-truncate mb-3">${escapeHtml(p.org)}</p>
              <div class="mt-auto d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary w-100" data-action="edit" data-id="${p.id}">Editar</button>
                <button class="btn btn-sm btn-outline-danger w-100" data-action="delete" data-id="${p.id}">Borrar</button>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      // attach listeners
      qsa('#cards [data-action="edit"]').forEach(btn => btn.addEventListener('click', onEditClick));
      qsa('#cards [data-action="delete"]').forEach(btn => btn.addEventListener('click', onDeleteClick));
    }

    // UI helpers
    function initials(fn, ln){
      const a = (fn||'').trim().charAt(0) || '';
      const b = (ln||'').trim().charAt(0) || '';
      return (a + b).toUpperCase() || '?';
    }

    function escapeHtml(s){
      if(!s) return '';
      return s.replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    }

    // Modal logic
    const personModal = new bootstrap.Modal(qs('#personModal'));
    const form = qs('#personForm');
    const modalTitle = qs('#modalTitle');
    const previewWrapper = qs('#previewWrapper');

    qs('#btnAdd').addEventListener('click', ()=>{
      openCreateModal();
    });

    qs('#photo').addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(file){
        const dataUrl = await readImageAsDataUrl(file);
        previewWrapper.innerHTML = `<img src="${dataUrl}" class="img-fluid rounded" style="max-height:200px;">`;
      } else previewWrapper.innerHTML = '';
    });

    function openCreateModal(){
      modalTitle.textContent = 'Crear alumno';
      form.reset();
      qs('#personId').value = '';
      previewWrapper.innerHTML = '';
      personModal.show();
    }

    function onEditClick(e){
      const id = e.currentTarget.dataset.id;
      const person = loadPeople().find(p=>p.id==id);
      if(!person) return alert('Alumno no encontrado');
      modalTitle.textContent = 'Editar alumno';
      qs('#personId').value = person.id;
      qs('#firstName').value = person.firstName || '';
      qs('#lastName').value = person.lastName || '';
      qs('#org').value = person.org || '';
      previewWrapper.innerHTML = person.photo ? `<img src="${person.photo}" class="img-fluid rounded" style="max-height:200px;">` : '';
      qs('#photo').value = '';
      personModal.show();
    }

    function onDeleteClick(e){
      const id = e.currentTarget.dataset.id;
      if(confirm('¿Borrar este alumno? Esta acción no se puede deshacer.')){
        deletePerson(id);
        renderCards(qs('#search').value);
      }
    }

    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const id = qs('#personId').value || String(Date.now());
      const firstName = qs('#firstName').value.trim();
      const lastName = qs('#lastName').value.trim();
      const org = qs('#org').value.trim();

      // If a new file was chosen, read it
      const file = qs('#photo').files[0];
      let photoData = null;
      if(file) photoData = await readImageAsDataUrl(file);

      const person = { id, firstName, lastName, org, photo: photoData || (loadPeople().find(p=>p.id==id)?.photo || null) };

      if(qs('#personId').value){
        updatePerson(person);
      } else {
        addPerson(person);
      }

      personModal.hide();
      renderCards(qs('#search').value);
    });

    // Search
    qs('#search').addEventListener('input', e=> renderCards(e.target.value));

    // On load
    document.addEventListener('DOMContentLoaded', ()=>{
      // seed example data if empty (optional)
      const people = loadPeople();
      if(people.length===0){
        const sample = [
          { id: String(Date.now()+1), firstName:'María', lastName:'González', org:'Ministerio de Ejemplo', photo:null },
          { id: String(Date.now()+2), firstName:'Luis', lastName:'Pérez', org:'Ayuntamiento', photo:null }
        ];
        savePeople(sample);
      }
      renderCards();
    });
  </script>
</body>
</html>
